package  {	    import flash.events.*;    import flash.net.URLLoader;    import flash.net.URLRequest;    import flash.net.URLRequestMethod;    import flash.net.URLVariables;    import flash.display.Loader;	public class SteelcaseAPI {        private var ready_functions:Array = [];        private var is_ready:Boolean = false;		private static var token:String = "";        private static var urls:Object = {             'token': '/api/auth/create/',            'trainee_login': '/api/trainee/login/',            'performance_add': '/api/performance/add/',            'glossary_get': '/api/glossary/get/',            'trainee_logout': '/api/auth/logout/'        };        private static var debug:Boolean = false;		public function SteelcaseAPI(token:String="", debug:Boolean=false) {            var self = this;            SteelcaseAPI.debug = debug;			if (token) {				SteelcaseAPI.token = token;			} else {				this.request_token(function(response){                     if (response.is_ok())                     {                        SteelcaseAPI.token = response.data.token;                    } else {                        trace(response);                    }                    self.ready(response);                });			}		}        public function ready(callback:*=null)        {            if (typeof(callback) == "function")            {                this.ready_functions.push(callback);                if (this.is_ready == true)                {                    this.ready(SteelcaseAPI.token);                }            }            else            {                for (var i in this.ready_functions)                {                    var ready_function = this.ready_functions[i];                    this.ready_functions.shift();                    ready_function(callback);                                        if ( ! this.is_ready )                    {                        this.is_ready = true;                    }                }            }        }        public function request_token(callback:Function):void {            var date:Date = new Date();            var timestamp:int = Math.round(date.getTime()/1000);                        var data:Object = {                 keyA:timestamp,                keyB:(timestamp + 4) * 4 / 10            };                        SteelcaseAPI.api_request(SteelcaseAPI.urls.token, data, callback);        }        public function trainee_login(employee_id:String, callback:Function):void {            var data:Object = {                token: SteelcaseAPI.token,                employee_id: employee_id            };            SteelcaseAPI.api_request(SteelcaseAPI.urls.trainee_login, data, callback);        }        public function performance_add(employee_id:String, module_id:Number, score:Number, duration:Number, meta:*=null, callback:*=null):void {            var data:Object = {                token: SteelcaseAPI.token,                employee_id: employee_id,                module_id: module_id,                score: score,                duration: duration,                meta: meta            };            SteelcaseAPI.api_request(SteelcaseAPI.urls.performance_add, data, callback);        }        public function glossary_get(callback:Function):void {            var data:Object = {                token: SteelcaseAPI.token            };            SteelcaseAPI.api_request(SteelcaseAPI.urls.glossary_get, data, callback);        }        public function trainee_logout(callback:Function):void {            var data:Object = {                token: SteelcaseAPI.token            };            var new_callback:Function = function(response){                if( response.is_ok() )                {                    SteelcaseAPI.token = "";                }                callback(response);            };            SteelcaseAPI.api_request(SteelcaseAPI.urls.trainee_logout, data, new_callback);        }        private static function api_request(url:String, data:Object, callback:Function):void {            var vars:URLVariables = new URLVariables();            vars.data   = JSON.stringify(data);            var request:URLRequest = new URLRequest();            request.method = URLRequestMethod.POST;            request.data = vars;            request.url = 'http://steelcase.dev' + url;                        var loader:URLLoader = new URLLoader();            loader.addEventListener(Event.COMPLETE, function(e){                 if (typeof(callback) == "function")                {                    callback( new JSONResponse(e.target.data) );                }            });            loader.addEventListener(IOErrorEvent.IO_ERROR, function(e:IOErrorEvent){                 trace(e.toString());            });                        loader.load(request);        }        public static function is_ok(data)        {            if (typeof(data) == "string" && SteelcaseAPI.is_json(data)) {                data = JSON.parse(data);            }             else if( typeof(data) != "object" ){                return false;            }            if (data.status == "ok")            {                return true;            } else {                return false;            }        }        public static function is_json(data:String) {            var pattern:RegExp = /^\{.*\}$/gi;            if (pattern.test(data)) {                return true;            } else {                return false;            }        }	}}class JSONResponse{    public var status:String = "";    public var message:String = "";    public var error_code:Number = -1;    public var data:Object = {};	public function JSONResponse(data)	{		if (typeof(data) == "string" && SteelcaseAPI.is_json(data))		{			data = JSON.parse(data);		}		else if (typeof(data) == "string" && ! SteelcaseAPI.is_json(data))		{			data = { 				status: 'fail', 				message: data,				error_code: 24			};		}		else if (typeof(data) != "object")		{			return;		}		for (var i in data) 		{			this[i] = data[i];		}	}	public function is_ok()	{		return SteelcaseAPI.is_ok(this);	}	public function toString()	{		return JSON.stringify(this);	}}